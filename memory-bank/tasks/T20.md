# T20: Implement Comprehensive Logging System
*Created: 2025-05-17 14:30*
*Last Updated: 2025-05-19 20:00*

## Overview
**Status**: ðŸ”„ In Progress
**Priority**: HIGH
**Started**: 2025-05-17
**Dependencies**: None

## Description
Implement a comprehensive logging system with Supabase to track arXiv queries, LLM usage, and system events. This system helps monitor API rate limits, track resource usage, and provide insights into system performance.

## Completion Criteria

### 1. Core Infrastructure âœ…
- âœ… Supabase logging setup
- âœ… Log cleanup policy
- âœ… Structured log format (JSONB)
- âœ… Log levels (INFO, WARN, ERROR, DEBUG)

### 2. API Monitoring âœ…
- âœ… Track all arXiv API calls
- âœ… Monitor rate limits
- âœ… Log query parameters
- âœ… Response status tracking

### 3. LLM Usage Tracking âœ…
- âœ… Monitor Gemini API calls
- âœ… Track token usage
- âœ… Log latency metrics
- âœ… Cost estimation via token counts

### 4. System Event Logging ðŸ”„
- â¬œ URL access patterns
- âœ… Error tracking
- âœ… Performance metrics
- â¬œ User actions (anonymous)

### 5. Analysis Tools ðŸ”„
- âœ… Token usage snapshots
- âœ… Usage statistics
- â¬œ Rate limit warnings
- â¬œ Error summaries

## Implementation Plan

### Phase 1: Core Infrastructure
1. Create FileLogger class
   - Initialize log directory
   - Implement log levels
   - Setup JSON formatting
   - Add basic rotation

2. Setup Directory Structure
   - Create logging directory
   - Define file naming convention
   - Implement cleanup routines

3. Define Core Interfaces
   - Logger interface
   - Log entry types
   - Configuration options

### Phase 2: API Integration
1. arXiv API Logging
   - Track all queries
   - Monitor rate limits
   - Log response status
   - Track errors

2. LLM API Logging
   - Monitor Gemini calls
   - Track token usage
   - Measure latency
   - Log costs

### Phase 3: System Events
1. URL Tracking
   - Log accessed URLs
   - Track response times
   - Monitor errors

2. Performance Metrics
   - System resource usage
   - Operation latency
   - Error rates

### Phase 4: Analysis Tools
1. Log Viewer
   - Basic UI
   - Filtering
   - Search

2. Statistics Generation
   - Usage reports
   - Error summaries
   - Rate limit status

## Files
- `src/lib/logging/`
  - `logger.ts` - Main logger class
  - `rotation.ts` - Log rotation
  - `formatters.ts` - Log formatting
  - `types.ts` - Type definitions
- `src/lib/logging/integrations/`
  - `arxiv.ts` - arXiv logging
  - `llm.ts` - LLM logging
- `src/components/admin/`
  - `LogViewer.tsx` - Log visualization
  - `Stats.tsx` - Usage statistics

## Technical Notes
- Use local storage first for privacy
- Implement log rotation to manage storage
- Focus on minimal performance impact
- Ensure thread-safe logging
- Use structured logging format
- Support different log levels
- Include timestamp and context with each log
- Implement proper error handling
- Add log compression for storage efficiency
- Support log filtering and search

## Progress
1. âœ… Phase 1: Core Infrastructure
   - âœ… Created Supabase logger
   - âœ… Created system_logs table with proper schema
   - âœ… Implemented log cleanup policy
   - âœ… Added comprehensive logging to ArXiv API
   - âœ… Added comprehensive logging to LLM API

2. âœ… Phase 2: API Integration
   - âœ… ArXiv API logging with:
     - Query parameters and URLs
     - Response metadata
     - Timing information
     - Fallback scenarios
   - âœ… LLM API logging with:
     - Model details
     - Token counts
     - Response content
     - Cache hits
     - Error scenarios

3. ðŸ”„ Phase 3: System Events and Analysis
   - âœ… Token usage tracking
   - âœ… Daily usage snapshots
   - âœ… Model usage breakdown
   - âœ… Performance metrics (latency, cache hits)
   - â¬œ User action tracking
   - â¬œ Error analysis tools

## Technical Notes
- Supabase system_logs table implemented with:
  - Proper schema (timestamp, level, component, message, metadata)
  - RLS policies for security
  - Automatic cleanup policy for logs older than 30 days
- Enhanced ArXiv logging captures:
  - Query URLs and parameters
  - Total results (both metadata and actual)
  - Timing metrics
  - Fallback scenarios
- Enhanced LLM logging captures:
  - Full response content
  - Token usage details
  - Cache status
  - Error scenarios with context
- Token tracking system includes:
  - Daily snapshots using pg_cron
  - Prompt and completion token tracking
  - Model usage statistics
  - Performance metrics (latency, cache hits, success rates)

## Files
- `src/lib/logging/supabase-logger.ts` - Main logger class
- `src/lib/arxiv.ts` - ArXiv API logging integration
- `src/lib/llm.ts` - LLM API logging integration
- `memory-bank/implementation-details/supabase-logging-setup.md` - Setup documentation

## Related Issues
- GitHub Issue #14: "Log all arxiv queries" âœ…
- GitHub Issue #15: "Track LLM token usage" âœ…